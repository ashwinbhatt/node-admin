<html>
  <head><title> App update</title></head>
  <body>
    <!-- <form name="form">
      <h3>Signup</h3>
      <label for="username">Username</label>
      <input type="text" id='username' name="username" placeholder="Enter username"></form>
      <label for="password">password</label>
      <input type="password" id="password" name="password" placeholder="Enter password"></input>
      <p></p>
      <label for="role">Role</label>
      <input type="text" id="role" name="role" placeholder="Enter role"></input>
      <p><submit onclick="updateReq()">Update</submit></p>
    </form> -->
    <div style="width: 60%;margin: 0 auto;">
        <form>
            <div>
                <option>Username</option>
                    <select id="username">
                </select>
            </div>
            <div>
                <input type='text' id='role' name='role' placeholder='Role' \>
            </div>
            <div>
                <submit onclick="updateReq()">Update</submit>
            </div>
        </form>
    </div>
  </body> 
  
  <script>
       
    var userEle = document.getElementById('username'),
        roleEle = document.getElementById('role')

    var usersData=undefined;


    function updateList(){
        var select = document.getElementById('username');
        usersData.forEach((userData, index) => {
            var opt = userData.username;
            var el = document.createElement("option");
            el.setAttribute('id', 'username_'+index)
            el.textContent = opt;
            el.value = opt;
            select.appendChild(el);
        });
    }

    function autoFillForm(userdata){
        var role = document.getElementById('role')
        role.placeholder = userdata.role;
        role.textContent=''
    }
    
    function setTriggers(){
        var activities = document.getElementById('username')
        activities.addEventListener("change", function() {
            if(activities.value == 'Username'){
                autoFillForm({role: 'Role'})
            }else{
                usersData.forEach(userData => {
                    if(userData.username == activities.value){
                        autoFillForm(userData)
                    }
                })
            }
        });
    }


    function getDataReq(){

        fetch('http://'+ document.location.host + '<%=url_base  %>' + '/users', {
            method: 'GET',
            headers: new Headers(),
            redirect: 'follow'
        }).then(response => {
            if(!response.ok){
                throw response.json()
            }
            return response.json()
        }).then(result => {
            console.log(result.message)
            usersData= result.usersData
            updateList()
            return
        }).then(() => {
            setTriggers()
        }).catch(error => {
            console.log(error)
        });
    }

        function updateReq(){
            
            const user = {
                username: username.value
            }

            if(roleEle.value.length>0){
                user['role']= role.value
            }
            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");
            var requestOptions = {
                method: 'PUT',
                headers: myHeaders,
                body: JSON.stringify({user: user}),
                redirect: 'follow'
            };



            fetch(window.location.href, requestOptions)
            .then(response => {
                if(!response.ok){
                    throw response.json()
                }
                return response.json();
            }).then(result=> {
                console.log('Valid')
                console.log(result.message)
                return
            }).catch(error=> {
                console.log('Invalid')
                error.then(res=> {
                    console.log(res.error)
                }).catch(err=> {
                    console.log(err)
                })
            })
        }

        getDataReq()
        

  </script>
</html>